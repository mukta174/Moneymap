<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Fetch HDFC UPI Transactions</title>
    <style>
        body { font-family: sans-serif; margin: 20px; }
        .error { color: red; font-weight: bold; margin-bottom: 10px; }
        .success { color: green; }
        .info { color: navy; }
        .transaction-list { margin-top: 20px; border-collapse: collapse; width: 100%; }
        .transaction-list th, .transaction-list td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        .transaction-list th { background-color: #f2f2f2; }
        label { display: block; margin-bottom: 5px;}
        input[type="email"], input[type="password"] { width: 300px; padding: 8px; margin-bottom: 10px; border: 1px solid #ccc; }
        button { padding: 10px 15px; cursor: pointer; background-color: #007bff; color: white; border: none; border-radius: 4px; }
        button:hover { background-color: #0056b3; }
        form { margin-bottom: 20px; padding: 15px; border: 1px solid #eee; background-color: #f9f9f9; border-radius: 5px;}
        hr { margin-top: 30px; margin-bottom: 30px; }
    </style>
</head>
<body>

    <h1>Fetch HDFC UPI Transactions</h1>
    <p>Enter your Gmail address and an <a href="https://myaccount.google.com/apppasswords" target="_blank" rel="noopener noreferrer">App Password</a> to fetch recent UPI transactions from HDFC Bank alerts.</p>
    <p class="info"><strong>Note:</strong> Your password is used only for this request to connect to Gmail via IMAP and is <strong>not stored</strong> by this application.</p>

    {# --- Input Form --- #}
    <form method="post">
        {% csrf_token %} {# Important for security #}
        <div>
            <label for="email_address">Gmail Address:</label>
            <input type="email" id="email_address" name="email_address" required value="{{ request.POST.email_address|default:'' }}"> {# Keep value on error #}
        </div>
        <div>
            <label for="app_password">App Password:</label>
            <input type="password" id="app_password" name="app_password" required> {# Password field shouldn't retain value #}
        </div>
        <button type="submit">Fetch Transactions</button>
    </form>
    {# --- End Input Form --- #}


    {# --- Display Results Area --- #}
    {% if submitted %}
        <hr>
        <h2>Results for: {{ email_used }}</h2>

        {# Display Errors #}
        {% if errors %}
            <div class="error">
                <h4>Encountered Errors:</h4>
                <ul>
                    {% for error in errors %}
                        <li>{{ error }}</li>
                    {% endfor %}
                </ul>
            </div>
        {% endif %}

        {# Display Transactions Table #}
        {% if transactions is not None %}
            {% if transactions %}
                <p class="success">Successfully fetched {{ transactions|length }} transaction(s):</p>
                <table class="transaction-list">
                    <thead>
                        <tr>
                            <th>Date (DD-MM-YY)</th>
                            <th>Amount (Rs.)</th>
                            <th>Party Name</th>
                            <th>VPA ID</th>
                            <th>Category</th> {# <-- Keep header #}
                        </tr>
                    </thead>
                    <tbody>
                        {% for txn in transactions %}
                            <tr>
                                <td>{{ txn.date }}</td>
                                <td>{{ txn.amount|floatformat:2 }}</td>
                                <td>{{ txn.party_name }}</td>
                                <td>{{ txn.vpa_id }}</td>
                                <td>{{ txn.category|default:'N/A' }}</td> {# <-- Keep cell #}
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% elif not errors %} {# Only show 'no transactions' if there were also no errors #}
                 <p class="info">No matching UPI transaction emails found for the search period, or the emails found did not contain recognizable transaction details.</p>
            {% endif %}
        {# No 'else' needed here, errors are handled above #}
        {% elif not errors %}
            {# This case handles if submitted=True, but transactions is None AND no errors occurred - should be rare #}
            <p class="info">No results to display. Please ensure the credentials are correct and try again.</p>
        {% endif %} {# End if transactions is not None #}

    {% endif %} {# end if submitted #}

</body>
</html>