{% extends 'base.html' %}
{% load static %} {# Load static if needed within blocks #}
{% load crispy_forms_tags %} {# Load crispy if you intend to use it #}

{% block title %}Fetch Transactions - Enter Password{% endblock %}

{% block extra_css %}
<style>
    /* Specific styles for the request_app_password page */
    .error { color: red; font-weight: bold; margin-bottom: 10px; border: 1px solid red; padding: 10px; background-color: #ffeeee; border-radius: 4px; }
    .info { color: #0c5460; background-color: #d1ecf1; border: 1px solid #bee5eb; padding: 15px; margin-bottom: 15px; border-radius: 4px; }
    label { display: block; margin-bottom: 5px; font-weight: bold; }
    /* Style form inputs within this page */
    .password-form-container input[type="password"] {
        width: 100%; /* Take full width of container */
        max-width: 400px; /* Limit max width */
        padding: 10px;
        margin-bottom: 15px;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-sizing: border-box;
    }
    .password-form-container button {
        padding: 10px 20px;
        cursor: pointer;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        font-size: 1em;
    }
    .password-form-container button:hover { background-color: #0056b3; }
    /* Container for the form */
    .password-form-container {
        margin-bottom: 20px;
        padding: 20px;
        border: 1px solid #eee;
        background-color: #f9f9f9;
        border-radius: 5px;
        max-width: 550px; /* Adjust max-width as needed */
    }
    hr { margin-top: 30px; margin-bottom: 30px; border: 0; border-top: 1px solid #eee; }
     /* Styles for Django messages */
    .alert { padding: 15px; margin-bottom: 20px; border: 1px solid transparent; border-radius: 4px; }
    .alert-danger { color: #721c24; background-color: #f8d7da; border-color: #f5c6cb; }
    .alert-success { color: #155724; background-color: #d4edda; border-color: #c3e6cb; }
    .alert-warning { color: #856404; background-color: #fff3cd; border-color: #ffeeba; }
    .alert-info { color: #0c5460; background-color: #d1ecf1; border-color: #bee5eb; }
    /* Ensure h1 has some margin */
    h1 { margin-bottom: 15px; }
</style>
{% endblock extra_css %}

{% block content %}

    <h1>Fetch Transactions</h1>
    <p>MoneyMap needs temporary access to scan the email account associated with your profile: <strong>{{ user_email }}</strong>.</p>
    <div class="info">
        <i class="fas fa-info-circle"></i> Please enter the <a href="https://myaccount.google.com/apppasswords" target="_blank" rel="noopener noreferrer">App Password</a> you generated specifically for MoneyMap from your email provider (e.g., Google). <strong>This password is used only for this single fetch operation and is NOT stored by MoneyMap.</strong>
    </div>

    {# --- Display Django Messages (e.g., form validation errors from previous attempt) --- #}
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }}" role="alert">
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}

    {# --- App Password Input Form --- #}
    <div class="password-form-container">
        <form method="post" action="{% url 'emailparser:fetch_expenses' %}" novalidate>
            {% csrf_token %} {# Important for security #}

            {# --- Manual Rendering (adjust if using crispy-forms) --- #}
            <div class="form-group"> {# Using .form-group for consistency if needed elsewhere #}
                {# Display field-specific errors above the field #}
                {% if form.app_password.errors %}
                    <div class="error">{{ form.app_password.errors }}</div>
                {% endif %}

                <label for="{{ form.app_password.id_for_label }}">{{ form.app_password.label }}:</label>
                {{ form.app_password }} {# Renders the <input type="password"> widget #}

                {% if form.app_password.help_text %}
                    <small style="color: #555; display: block; margin-top: 5px;">{{ form.app_password.help_text|safe }}</small>
                {% endif %}
            </div>
            {# --- End Manual Rendering --- #}

            {# Use name="fetch_initial" or similar if you need to distinguish actions in the view #}
            <button type="submit" name="fetch_initial">
                 <i class="fas fa-envelope-open-text"></i> Fetch Transactions
            </button>
        </form>
    </div>
    {# --- End Input Form --- #}

    {# Removed the cancel link as the sidebar provides navigation #}
    {# <p style="margin-top: 20px;">
         <a href="{% url 'home' %}" style="text-decoration: none; color: #0056b3;">Cancel / Back to Home</a>
     </p> #}

{% endblock content %}