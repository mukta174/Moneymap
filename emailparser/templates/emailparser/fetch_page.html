<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Fetch HDFC UPI Transactions</title>
    <style>
        body { font-family: sans-serif; margin: 20px; }
        .error { color: red; font-weight: bold; margin-bottom: 10px; }
        .success { color: green; }
        .info { color: navy; }
        .transaction-list { margin-top: 20px; border-collapse: collapse; width: 100%; }
        .transaction-list th, .transaction-list td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        .transaction-list th { background-color: #f2f2f2; }
        label { display: block; margin-bottom: 5px;}
        input[type="email"], input[type="password"] { width: 300px; padding: 8px; margin-bottom: 10px; }
        button { padding: 10px 15px; cursor: pointer; }
    </style>
</head>
<body>

    <h1>Fetch HDFC UPI Transactions</h1>
    <p>Enter your Gmail address and an <a href="https://myaccount.google.com/apppasswords" target="_blank" rel="noopener noreferrer">App Password</a> to fetch today's UPI transactions from HDFC Bank alerts.</p>
    <p class="info"><strong>Note:</strong> Your password is used only for this request and is not stored.</p>

    <form method="post">
        {% csrf_token %} {# Important for security #}
        <div>
            <label for="email_address">Gmail Address:</label>
            <input type="email" id="email_address" name="email_address" required>
        </div>
        <div>
            <label for="app_password">App Password:</label>
            <input type="password" id="app_password" name="app_password" required>
        </div>
        <button type="submit">Fetch Transactions</button>
    </form>

    {# --- Display Results Area --- #}
    {% if submitted %}
        <hr>
        <h2>Results for {{ email_used }}</h2>

        {# Display Errors #}
        {% if errors %}
            <div class="error">
                <h4>Encountered Errors:</h4>
                <ul>
                    {% for error in errors %}
                        <li>{{ error }}</li>
                    {% endfor %}
                </ul>
            </div>
        {% endif %}

        {# Display Transactions #}
        {# ... inside the <body> tag, where the results table is ... #}

            {% if transactions is not None %}
                {% if transactions %}
                    <p class="success">Successfully fetched and categorized {{ transactions|length }} transaction(s):</p>
                    <table class="transaction-list">
                        <thead>
                            <tr>
                                <th>Date (DD-MM-YY)</th>
                                <th>Amount (Rs.)</th>
                                <th>Party Name</th>
                                <th>VPA ID</th>
                                #<th>Category</th> {# <-- ADDED HEADER #}
                            </tr>
                        </thead>
                        <tbody>
                            {% for txn in transactions %}
                                <tr>
                                    <td>{{ txn.date }}</td>
                                    <td>{{ txn.amount|floatformat:2 }}</td>
                                    <td>{{ txn.party_name }}</td>
                                    <td>{{ txn.vpa_id }}</td>
                                    {# VVV ADDED CELL - Use default filter for safety VVV #}
                                    <td>{{ txn.category|default:'N/A' }}</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% elif not errors %}
                     <p class="info">No UPI transactions found in HDFC emails for the period, or no matching emails found.</p>
                {% endif %}
            {% elif submitted and not errors %} {# Handle case where submitted but no transactions and no specific fetch errors #}
                 <p class="info">No results to display. Check if credentials are correct and emails exist.</p>
            {% endif %} {# end if transactions is not None #}
            
            {# ... rest of the template ... #}
    {% endif %} {# end if submitted #}

</body>
</html>